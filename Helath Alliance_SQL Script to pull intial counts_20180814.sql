-----------------Helath Alliance
-- Facility Provider Ids check for the provided 3 Facilities in the CMS_NPI table
select * from RWD_DB.rwd.THIRD_PARTY_CMSNPI
where entity_type_code = 2
limit 10

select NPI,PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME
from RWD_DB.rwd.THIRD_PARTY_CMSNPI
where entity_type_code = 2
and (PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Rush Copley%' 
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Rush-Copley%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%RushCopley%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Carle%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%St. Vincent Anderson%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Vincent Anderson%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%ST.VINCENT%' 
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%VincentAnderson%' 
    )
	
---Query-2 (QC): Manually verified the Hospital names and filterd here just to make sure that we have used right facilites with Provider ids
with T1 as(
select NPI,PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME
from RWD_DB.rwd.THIRD_PARTY_CMSNPI
where entity_type_code = 2
and (PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Rush Copley%' 
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Rush-Copley%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Carle%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%St. Vincent Anderson%'
  or PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME ilike '%Vincent Anderson%'
    )
)
select PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME,
count(distinct npi) as NPI_cnt
from T1
where PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME in ('THE CARLE FOUNDATION HOSPITAL','STVINCENT ANDERSON REGIONAL HOSPITAL, INC.','STAND-UP MRI OF CARLE PLACE, P.C.','ST.VINCENT ANDERSON REGIONAL HOSPITAL','ST. VINCENT ANDERSON REGIONAL HOSPITAL, INC.','RUSH-COPLEY SURGICENTER, LLC','RUSH-COPLEY ORTHOPEDICS, LLC','RUSH-COPLEY MEDICAL GROUP, NFP','RUSH-COPLEY MEDICAL GROUP NFP','RUSH-COPLEY MEDICAL GROUP','RUSH-COPLEY HOSPITALISTS, LLC','RUSH COPLEY MEDICAL GROUP','RUSH COPLEY CARDIOVASCULAR CONSULTANTS, LLC','NURSES AT HOME BY CARLE','HEART HORIZONS LLC DBA RUSH COPLEY CARDIAC DIAGNOSTIC CENTER','CARLETON-WILLARD HOMES, INC.','CARLE SURGICENTER','CARLE SPORTS MEDICINE','CARLE RX EXPRESS PHARMACY','CARLE PLACE UFSD','CARLE PLACE SPORT & ORTHOPEDIC PHYSICAL THERAPY PC','CARLE PLACE DENTAL, P.C.','CARLE HOSPITAL','CARLE HIGH SCHOOL','CARLE HEALTHCARE, INC.','CARLE HEALTH CARE INCORPORATED','CARLE FOUNDATION PHYSICIAN SERVICES, LLC','CARLE FOUNDATION PHYSICIAN SERVICES LLC','CARLE FOUNDATION HOSPITAL','CARLE CLINIC ASSOCIATION, PC','CARLE CLINIC ASSOCIATION, P.C.','CARLE CLINIC ASSOCIATION','CARLE CLINIC ASSOCATION, P.C.','CARLE CHIROPRACTIC CLINIC','CARLE ARBOURS, INC.','CARLE')
group by PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME

----------------------------------> DATA PULL (After finalized of Provider ids)
--Query-3: New table contains NPIs (NPIs got from the master table(manually created in excel) - from different sources)
Create or replace table sandbox_analytics.sandbox.skr_health_alliance_NPIs_01 as
select NPI, PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME,
case when npi in ('1346764438','1457711582','1326566290','1528430162','1174923767','1467549402','1205230844','1851582563','1831270081','1508088303','1215254297','1154646776','1336464957','1215251384','1306160478','1588988653','1316261480','1851615926','1356664767','1366765786','1003139411','1275856684','1780907196','1114240876','1235452996','1295058824','1932422565','1730401266','1417279944','1154653947','1558690198','1801049325','1801048541','1992957633','1295826584','1710221064','1255688974','1881675635','1083605810','1972592160','1457347668','1609906999','1528067394','1437559028','1205236924','1053711770','1891102851','1285049072','1710398383','1629341011','1689946022','1851387385','1891780615','1861407645','1255352464','1154523934','1568671998','1083736177','1093835886','1295855088','1437275328','1376669267','1548391014','1811028376','1700917309','1720119290','1023149580','1306977863','1003947557','1730219627','1164552113','1194855098','1326178211','1821128786','1992836639','1477982684','1255380846','1861440778','1831156124','1053378349','1104883487','1225330806','1265734800','1124320700','1649588443','1477860427','1821305871','1437465325','1649466186','1336482025','1013071653','1760438204','1437293537','1255473187','1053467050','1366597510','1972658318','1023163441','1720133119','1366597742','1972658789','1013062454','1578618914','1073668836','1871648600','1285784967','1619034659','1225194533','1508922022','1841480589','1861648099','1427225044','1669647285','1265605117','1720250160','1942489141','1942226600') 
            then 'Carle'
     when npi in ('1982985032','1629003165','1619466034','1639455173','1841579893','1477831220','1184715625','1295836534','1013018340','1477654788','1568563872','1942301270','1033210364','1750482089','1093815482','1376643767','1376894501','1316303860','1093075848','1528105723','1205846052','1194836247','1003019548','1982974689','1710293329','1508055351','1629265764','1679745293','1538616693','1962959296','1659666907') 
            then 'Rush-copley'
     when npi in ('1942376843','1427480029','1659624179','1598018053','1144573601','1427300771','1972855229','1679578850','1043640626','1871939330','1154766707','1770928327','1376619288','1497932115','1003098930','1891919783','1740404631') 
            then 'VINCENT ANDERSON'
end as Hospital_flag
from RWD_DB.rwd.THIRD_PARTY_CMSNPI
where npi in ('1942376843','1427480029','1659624179','1598018053','1144573601','1427300771','1972855229','1679578850','1043640626','1871939330','1154766707','1770928327','1376619288','1497932115','1003098930','1891919783','1740404631','1982985032','1629003165','1619466034','1639455173','1841579893','1477831220','1184715625','1295836534','1013018340','1477654788','1568563872','1942301270','1033210364','1750482089','1093815482','1376643767','1376894501','1316303860','1093075848','1528105723','1205846052','1194836247','1003019548','1982974689','1710293329','1508055351','1629265764','1679745293','1538616693','1962959296','1659666907','1346764438','1457711582','1326566290','1528430162','1174923767','1467549402','1205230844','1851582563','1831270081','1508088303','1215254297','1154646776','1336464957','1215251384','1306160478','1588988653','1316261480','1851615926','1356664767','1366765786','1003139411','1275856684','1780907196','1114240876','1235452996','1295058824','1932422565','1730401266','1417279944','1154653947','1558690198','1801049325','1801048541','1992957633','1295826584','1710221064','1255688974','1881675635','1083605810','1972592160','1457347668','1609906999','1528067394','1437559028','1205236924','1053711770','1891102851','1285049072','1710398383','1629341011','1689946022','1851387385','1891780615','1861407645','1255352464','1154523934','1568671998','1083736177','1093835886','1295855088','1437275328','1376669267','1548391014','1811028376','1700917309','1720119290','1023149580','1306977863','1003947557','1730219627','1164552113','1194855098','1326178211','1821128786','1992836639','1477982684','1255380846','1861440778','1831156124','1053378349','1104883487','1225330806','1265734800','1124320700','1649588443','1477860427','1821305871','1437465325','1649466186','1336482025','1013071653','1760438204','1437293537','1255473187','1053467050','1366597510','1972658318','1023163441','1720133119','1366597742','1972658789','1013062454','1578618914','1073668836','1871648600','1285784967','1619034659','1225194533','1508922022','1841480589','1861648099','1427225044','1669647285','1265605117','1720250160','1942489141','1942226600')

--Initial counts
select hospital_flag,
count(distinct npi) as npi_cnt
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_01
group by hospital_flag

--------Pulling claims data through NPIs
create or replace table sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02 as
select Distinct A.*,
b.PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME,
b.Hospital_flag
from rwd_db.RWD.RAVEN_CLAIMS_SUBMITS_PROVIDER A
inner join sandbox_analytics.sandbox.skr_health_alliance_NPIs_01 B
on cast(A.Provider_npi  as varchar) = cast(B.npi  as varchar)

select count(*) from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02 --4,128,837

--Results: Claim and Provider count by Hospital
select Hospital_flag,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02
where ENTITY_TYPE_CODE = 2
group by Hospital_flag

------------------------------------------------------------------------------------->PAYER DATA PULL
-- Pulling Payer information for the claims
CREATE OR REPLACE TABLE sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_03 AS
SELECT DISTINCT A.*, 
/*CONDOR*/
B.PAYER_ID AS CONDOR_PAYER_ID, 
UPPER(TRIM(B.PAYER_NAME)) AS CONDOR_RAW_PAYER_NAME, 
B.FINGERTIP_PAYER_ID AS CONDOR_FINGERTIP_PAYER_ID,
UPPER(TRIM(B.FINGERTIP_PAYER_NAME)) AS CONDOR_MASTER_PAYER_NAME, 
B.FINGERTIP_PARENT_ID AS CONDOR_FINGERTIP_PARENT_ID,
UPPER(TRIM(B.FINGERTIP_PARENT_NAME)) AS CONDOR_FINGERTIP_PARENT_NAME,

/*VULTURE*/
C.PAYER_ID AS VULTURE_PAYER_ID, 
C.NAME AS VULTURE_RAW_PAYER_NAME,
C.FINGERTIP_PAYER_ID AS VULTURE_FINGERTIP_PAYER_ID,
UPPER(TRIM(C.FINGERTIP_PAYER_NAME)) AS VULTURE_MASTER_PAYER_NAME, 
C.FINGERTIP_PARENT_ID AS VULTURE_FINGERTIP_PARENT_ID, 
UPPER(TRIM(C.FINGERTIP_PARENT_NAME)) AS VULTURE_FINGERTIP_PARENT_NAME, 

/*ALBATROSS*/
D.TSPID AS ALBATORSS_PAYER_ID_1, 
D.PRIMARYPAYERID AS ALBATORSS_PAYER_ID_2, 
UPPER(TRIM(D.PRIMARYPAYERNAME)) AS ALBATORSS_RAW_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PAYER_ID AS ALBATROSS_PRIMARY_FINGERTIP_PAYER_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PAYER_NAME)) AS ALBATROSS_PRIMARY_MASTER_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PARENT_ID AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PARENT_NAME)) AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_NAME, 

/*CONDOR PHARMACY*/
E.PAYER_ID AS PHARMACY_PAYER_ID, 
E.INFERRED_PAYER_1 AS PHARMACY_INFERRED_PAYER_ID 

FROM 
sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02 AS A
LEFT JOIN
RWD_DB.RWD.CONDOR_CLAIM_RECORD AS B
ON A.CLAIM_NUMBER = ('con_'|| B.CLAIM_NUMBER)
LEFT JOIN
(SELECT * FROM RWD_DB.RWD.VULTURE_PAYER WHERE SEQUENCE_NUMBER = 1) AS C
ON A.CLAIM_NUMBER = ('vul_'||C.CLAIM_ID)
LEFT JOIN
RWD_DB.RWD.ALBATROSS_CLAIMS_HEADER AS D
ON A.CLAIM_NUMBER = ('alb_'||D.ENTITYID)
LEFT JOIN
RWD_DB.RWD.CONDOR_PHARMACY_RECORD AS E
ON A.CLAIM_NUMBER = E.CONDOR_TDR_CLAIMID;

------------------------------------------------------QC starts
--Results: Claim and Provider count by Hospital
with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTHALLIANCE%' then 'HEALTH ALLIANCE'  
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUECROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_03
)
--query-1
select Payer_flag,
coalesce(CONDOR_PAYER_ID,VULTURE_PAYER_ID,ALBATORSS_PAYER_ID_1,ALBATORSS_PAYER_ID_2) as Payer_ID,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Payer_flag,Payer_ID


with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTHALLIANCE%' then 'HEALTH ALLIANCE'  
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUECROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_03
)
--query-1
select PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME, provider_npi,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME, provider_npi

--query-2
select Hospital_flag,Payer_flag,ADR_STATE,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Hospital_flag,Payer_flag,ADR_STATE

--Checking for the PAYER_ID information in our data
select * from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_03
where CONDOR_FINGERTIP_PAYER_ID = '176'
------------------------------------------------------QC ends

------------------------------------------------------------------------------------ Type of coverage (for channel_type)
create or replace table sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_04 as
with T1 as(
select A.*, 
B.payer_id,
B.payer_name,
B.TYPE_COVERAGE
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_03 A
left join rwd_db.RWD.RAVEN_CLAIMS_SUBMITS_PAYER  B
on A.claim_number=b.claim_number
)
select *,
CASE 
		WHEN trim(upper(type_coverage)) IN ('3', '03', 'AM', 'BL', '10', 'CI', '5', '05', 'DS', '14', 'R', 'HM', 'Y', '16', '02', 'LI', 'W', '01', 'LM', '13', 'Q', 'N', '08', 'G', 'K', 'S', 'B', '1', 'X', '7', '17', '15', 'WC', 'F', 'I', '07', 'P', '2', '12', '8')
			THEN 'Commercial'
		WHEN trim(upper(type_coverage)) IN ('D', 'MC')
			THEN 'Medicaid'
		WHEN trim(upper(type_coverage)) IN ('MA', 'C', 'U', 'MB')
			THEN 'Medicare'
		ELSE 'Other'
		END AS CHANNEL_TYPE
from T1;


--Results pull with the channel_type
with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
    -- when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     --when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_Payer_04
)
select Hospital_flag,CHANNEL_TYPE,Payer_flag,ADR_STATE,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Hospital_flag,CHANNEL_TYPE,Payer_flag,ADR_STATE


---------------------------------------PULLING OVERALL CLAIMS DATA FOR IL AND IN STATES (to cross the coverage with Lives data)

--Extract ALL claims data for IL & IN
--Table-1:
create or replace table sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN as
select Distinct *
from rwd_db.RWD.RAVEN_CLAIMS_SUBMITS_PROVIDER 
where  upper(ADR_state) in ('IL','IN')

--Results:
select upper(ADR_state) as ADR_state,
count(distinct Claim_number) as claim_count
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN
group by upper(ADR_state)

--Table-2: Only for the 3 Facility's:

create table sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F as
select A.*,
b.PROVIDER_ORGANIZATION_NAME_LEGAL_BUSINESS_NAME as Facility,
b.Hospital_flag
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN A
inner join sandbox_analytics.sandbox.skr_health_alliance_NPIs_01 B
on cast(A.Provider_npi  as varchar) = cast(B.npi  as varchar)

------Query-3
select upper(ADR_state) as ADR_state,Hospital_flag,
count(distinct Claim_number) as claim_count
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F
group by upper(ADR_state), Hospital_flag


---------------------------------------- Pulling Payer information for the claims (for the 3 facilities)
CREATE OR REPLACE TABLE sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F_payer AS
SELECT DISTINCT A.*, 
/*CONDOR*/
B.PAYER_ID AS CONDOR_PAYER_ID, 
UPPER(TRIM(B.PAYER_NAME)) AS CONDOR_RAW_PAYER_NAME, 
B.FINGERTIP_PAYER_ID AS CONDOR_FINGERTIP_PAYER_ID,
UPPER(TRIM(B.FINGERTIP_PAYER_NAME)) AS CONDOR_MASTER_PAYER_NAME, 
B.FINGERTIP_PARENT_ID AS CONDOR_FINGERTIP_PARENT_ID,
UPPER(TRIM(B.FINGERTIP_PARENT_NAME)) AS CONDOR_FINGERTIP_PARENT_NAME,

/*VULTURE*/
C.PAYER_ID AS VULTURE_PAYER_ID, 
C.NAME AS VULTURE_RAW_PAYER_NAME,
C.FINGERTIP_PAYER_ID AS VULTURE_FINGERTIP_PAYER_ID,
UPPER(TRIM(C.FINGERTIP_PAYER_NAME)) AS VULTURE_MASTER_PAYER_NAME, 
C.FINGERTIP_PARENT_ID AS VULTURE_FINGERTIP_PARENT_ID, 
UPPER(TRIM(C.FINGERTIP_PARENT_NAME)) AS VULTURE_FINGERTIP_PARENT_NAME, 

/*ALBATROSS*/
D.TSPID AS ALBATORSS_PAYER_ID_1, 
D.PRIMARYPAYERID AS ALBATORSS_PAYER_ID_2, 
UPPER(TRIM(D.PRIMARYPAYERNAME)) AS ALBATORSS_RAW_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PAYER_ID AS ALBATROSS_PRIMARY_FINGERTIP_PAYER_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PAYER_NAME)) AS ALBATROSS_PRIMARY_MASTER_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PARENT_ID AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PARENT_NAME)) AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_NAME, 

/*CONDOR PHARMACY*/
E.PAYER_ID AS PHARMACY_PAYER_ID, 
E.INFERRED_PAYER_1 AS PHARMACY_INFERRED_PAYER_ID 

FROM 
sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F AS A
LEFT JOIN
RWD_DB.RWD.CONDOR_CLAIM_RECORD AS B
ON A.CLAIM_NUMBER = ('con_'|| B.CLAIM_NUMBER)
LEFT JOIN
(SELECT * FROM RWD_DB.RWD.VULTURE_PAYER WHERE SEQUENCE_NUMBER = 1) AS C
ON A.CLAIM_NUMBER = ('vul_'||C.CLAIM_ID)
LEFT JOIN
RWD_DB.RWD.ALBATROSS_CLAIMS_HEADER AS D
ON A.CLAIM_NUMBER = ('alb_'||D.ENTITYID)
LEFT JOIN
RWD_DB.RWD.CONDOR_PHARMACY_RECORD AS E
ON A.CLAIM_NUMBER = E.CONDOR_TDR_CLAIMID;

select * from RWD_DB.RWD.ALBATROSS_CLAIMS_HEADER limit 10
select * from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F_payer limit 10

--Results: Claim and Provider count by Hospital
with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTHALLIANCE%' then 'HEALTH ALLIANCE'  
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUECROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F_payer
)
/*
--query-1
select coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) as Payer,
coalesce(CONDOR_PAYER_ID,VULTURE_PAYER_ID,ALBATORSS_PAYER_ID_1,ALBATORSS_PAYER_ID_2) as Payer_ID,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Payer,Payer_ID
*/
--query-2
select Hospital_flag,Payer_flag,ADR_STATE,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Hospital_flag,Payer_flag,ADR_STATE


with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTHALLIANCE%' then 'HEALTH ALLIANCE'  
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUECROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_3F_payer
)
--query-1
select Hospital_flag,Payer_flag,ADR_STATE,
count(distinct claim_number) as claim_count,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Hospital_flag,Payer_flag,ADR_STATE

----------------------------------Overall count 
--sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN

---------------------------------------- Pulling Payer information for the claims irresepective of 3 facilites (just to cross check with Lives data)
CREATE OR REPLACE TABLE sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_payer_overall AS
SELECT DISTINCT A.*, 
/*CONDOR*/
B.PAYER_ID AS CONDOR_PAYER_ID, 
UPPER(TRIM(B.PAYER_NAME)) AS CONDOR_RAW_PAYER_NAME, 
B.FINGERTIP_PAYER_ID AS CONDOR_FINGERTIP_PAYER_ID,
UPPER(TRIM(B.FINGERTIP_PAYER_NAME)) AS CONDOR_MASTER_PAYER_NAME, 
B.FINGERTIP_PARENT_ID AS CONDOR_FINGERTIP_PARENT_ID,
UPPER(TRIM(B.FINGERTIP_PARENT_NAME)) AS CONDOR_FINGERTIP_PARENT_NAME,

/*VULTURE*/
C.PAYER_ID AS VULTURE_PAYER_ID, 
C.NAME AS VULTURE_RAW_PAYER_NAME,
C.FINGERTIP_PAYER_ID AS VULTURE_FINGERTIP_PAYER_ID,
UPPER(TRIM(C.FINGERTIP_PAYER_NAME)) AS VULTURE_MASTER_PAYER_NAME, 
C.FINGERTIP_PARENT_ID AS VULTURE_FINGERTIP_PARENT_ID, 
UPPER(TRIM(C.FINGERTIP_PARENT_NAME)) AS VULTURE_FINGERTIP_PARENT_NAME, 

/*ALBATROSS*/
D.TSPID AS ALBATORSS_PAYER_ID_1, 
D.PRIMARYPAYERID AS ALBATORSS_PAYER_ID_2, 
UPPER(TRIM(D.PRIMARYPAYERNAME)) AS ALBATORSS_RAW_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PAYER_ID AS ALBATROSS_PRIMARY_FINGERTIP_PAYER_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PAYER_NAME)) AS ALBATROSS_PRIMARY_MASTER_PAYER_NAME, 
D.PRIMARY_FINGERTIP_PARENT_ID AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_ID, 
UPPER(TRIM(D.PRIMARY_FINGERTIP_PARENT_NAME)) AS ALBATROSS_PRIMARY_FINGERTIP_PARENT_NAME, 

/*CONDOR PHARMACY*/
E.PAYER_ID AS PHARMACY_PAYER_ID, 
E.INFERRED_PAYER_1 AS PHARMACY_INFERRED_PAYER_ID 

FROM 
sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN AS A
LEFT JOIN
RWD_DB.RWD.CONDOR_CLAIM_RECORD AS B
ON A.CLAIM_NUMBER = ('con_'|| B.CLAIM_NUMBER)
LEFT JOIN
(SELECT * FROM RWD_DB.RWD.VULTURE_PAYER WHERE SEQUENCE_NUMBER = 1) AS C
ON A.CLAIM_NUMBER = ('vul_'||C.CLAIM_ID)
LEFT JOIN
RWD_DB.RWD.ALBATROSS_CLAIMS_HEADER AS D
ON A.CLAIM_NUMBER = ('alb_'||D.ENTITYID)
LEFT JOIN
RWD_DB.RWD.CONDOR_PHARMACY_RECORD AS E
ON A.CLAIM_NUMBER = E.CONDOR_TDR_CLAIMID;


---Query to pull claims and patient IDs for overall claims irresepective of 3 facilites
with T1 as(
select *,
case when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTH ALLIANCE%' then 'HEALTH ALLIANCE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%HEALTHALLIANCE%' then 'HEALTH ALLIANCE'  
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICARE%' then 'MEDICARE'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%MEDICAID%' then 'MEDICAID'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BCBS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUE CROSS%' then 'BCBS'
     when coalesce(CONDOR_RAW_PAYER_NAME,VULTURE_RAW_PAYER_NAME,ALBATORSS_RAW_PAYER_NAME) ilike '%BLUECROSS%' then 'BCBS'  
     Else 'Other'
     end as Payer_flag  
from sandbox_analytics.sandbox.skr_health_alliance_NPIs_with_claims_02_ALL_IL_IN_payer_overall
)
--query-1
select Payer_flag,ADR_STATE,
count(distinct claim_number) as claim_count,
count(distinct encrypted_key_1,encrypted_key_2) as Patient_cnt,
count(distinct Provider_npi) as Provider_count
from T1
where ENTITY_TYPE_CODE = 2
group by Payer_flag,ADR_STATE